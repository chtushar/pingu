# Storage

Pingu persists conversation history in SQLite using a simple turns-based model.

## Database

The database is a SQLite file (default: `~/.local/share/pingu/pingu.db`) opened with WAL mode and foreign keys enabled. The path is configurable via `[db] path` in `config.toml`.

The schema is embedded in the binary via `//go:embed` and applied automatically on startup with `database.Migrate()`.

## Schema

### `sessions`

Tracks conversation sessions. Each channel + chat combination gets one session.

| Column | Type | Description |
|--------|------|-------------|
| `id` | TEXT PK | Session identifier (e.g. `telegram:648079060`) |
| `channel` | TEXT | Channel type (e.g. `"default"`) |
| `channel_id` | TEXT | Channel-specific ID |
| `title` | TEXT | Session title |
| `model` | TEXT | LLM model used |
| `summary` | TEXT | Conversation summary (for future compaction) |
| `summary_up_to` | INTEGER | Turn ID up to which summary covers |
| `created_at` | DATETIME | Creation timestamp |
| `updated_at` | DATETIME | Last activity timestamp |

### `turns`

Stores each user message and the full LLM response as a pair.

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PK | Auto-incrementing turn ID |
| `session_id` | TEXT FK | References `sessions.id` |
| `user_message` | TEXT | The user's input |
| `response_json` | TEXT | Full `responses.Response` serialized as JSON |
| `model` | TEXT | Model used for this turn |
| `created_at` | DATETIME | Timestamp |

### `messages`

Individual message storage (defined in schema but not currently used by the history system). Reserved for future fine-grained message tracking.

## History Store

The `history.Store` (`internal/history/history.go`) provides the interface between the agent and the database.

### `EnsureSession(ctx, sessionID, channel)`

Creates the session if it doesn't exist, or updates `updated_at` if it does. Called at the start of every `Run`.

### `SaveTurn(ctx, sessionID, userMessage, response)`

Saves a completed turn — the user's message and the full `Response` object as JSON. Called after the agent loop finishes.

### `LoadInputHistory(ctx, sessionID)`

Loads all turns for a session and reconstructs the conversation as `[]ResponseInputItemUnionParam` — the format the LLM expects. This is how the agent has memory across turns.

The reconstruction handles all output item types:
- `message` — text responses
- `function_call` — tool invocations
- `reasoning` — chain-of-thought blocks
- `file_search_call`, `web_search_call`, `computer_call`, `code_interpreter_call`

Each output item is converted back to an input item using the SDK's `ToParam()` method for lossless round-tripping.

## Session IDs

Session IDs are strings with a conventional format:

| Pattern | Example | Source |
|---------|---------|--------|
| `telegram:{chat_id}` | `telegram:648079060` | Telegram channel |
| `{parent}:delegate:{agent}` | `telegram:648079060:delegate:sysinfo` | Delegate tool |

Sub-agent sessions are kept separate from the parent so their history doesn't pollute the main conversation.

## Code Generation

The database queries are generated by [sqlc](https://sqlc.dev/). The source SQL is in:

- `internal/db/schema.sql` — table definitions
- `internal/db/queries.sql` — named queries

Generated files (`db.go`, `models.go`, `queries.sql.go`) should not be edited by hand. Run `sqlc generate` after modifying the SQL files.
